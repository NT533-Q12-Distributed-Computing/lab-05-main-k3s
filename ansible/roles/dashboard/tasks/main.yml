---
# ==========================================================
# ğŸš€ ROLE: Install Kubernetes Dashboard (YAML method - stable)
# ==========================================================

- name: ğŸ“Œ Ensure kubeconfig available
  shell: |
    mkdir -p /root/.kube
    cp /etc/rancher/k3s/k3s.yaml /root/.kube/config
    chmod 600 /root/.kube/config
  args:
    executable: /bin/bash

- name: â³ Wait for Kubernetes API
  shell: kubectl get nodes --no-headers
  retries: 10
  delay: 8
  register: kube_ready
  until: kube_ready.rc == 0

# ==========================================================
# Install Dashboard (official manifests)
# ==========================================================

- name: ğŸš€ Install Kubernetes Dashboard YAML
  shell: |
    kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml
  args:
    executable: /bin/bash
  register: dash_yaml
  retries: 3
  delay: 10
  until: dash_yaml.rc == 0

# ==========================================================
# Expose Dashboard via NodePort
# ==========================================================

- name: ğŸŒ Patch service to NodePort
  shell: |
    kubectl -n kubernetes-dashboard patch svc kubernetes-dashboard \
      -p '{"spec": {"type": "NodePort"}}'
  args:
    executable: /bin/bash

- name: ğŸ” Get NodePort
  shell: |
    kubectl -n kubernetes-dashboard get svc kubernetes-dashboard \
      -o jsonpath='{.spec.ports[0].nodePort}'
  register: dash_port
  changed_when: false

- name: ğŸ“¡ Get Master Public IP
  shell: curl -s http://169.254.169.254/latest/meta-data/public-ipv4
  register: master_pub
  changed_when: false

# ==========================================================
# Create admin user + token
# ==========================================================

- name: ğŸ§‘â€ğŸ’» Create Admin user manifest
  copy:
    dest: /tmp/admin-user.yaml
    content: |
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: admin-user
        namespace: kubernetes-dashboard
      ---
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: admin-user
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: cluster-admin
      subjects:
      - kind: ServiceAccount
        name: admin-user
        namespace: kubernetes-dashboard

- name: ğŸ“ Apply admin user
  shell: kubectl apply -f /tmp/admin-user.yaml
  args:
    executable: /bin/bash

- name: ğŸ”‘ Get admin token
  shell: kubectl -n kubernetes-dashboard create token admin-user
  register: admin_token
  changed_when: false

- debug:
    msg:
      - "ğŸ‰ Kubernetes Dashboard Installed Successfully!"
      - "ğŸŒ URL: https://{{ master_pub.stdout }}:{{ dash_port.stdout }}"
      - "ğŸ”‘ Token (copy into browser login):"
      - "{{ admin_token.stdout }}"
